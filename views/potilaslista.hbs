<!-- potilaslista.hbs -->
{{#if patients}}
<div class="row">
    <div class="col">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Patient Name</th> <!-- Add class for text center -->
                    </tr>
                </thead>
                <tbody>
                  {{#each patients}}
                    {{#if nimi}} 
                      <tr>
                          <td class="text-center"> 
                            <a href="#" class="patient-name" data-patient-id="{{_id}}">{{nimi}}</a>
                          </td>
                      </tr>
                    {{/if}}
                  {{/each}}
                </tbody>
            </table>
            <div class="measurement-container"></div>
        </div>
    </div>
</div>
{{else}}
<p>Potilaita ei l√∂ydy</p>
{{/if}}




<script>
  const patientNames = document.querySelectorAll('.patient-name');
  const stories = {{json stories}};

  patientNames.forEach(patientName => {
    patientName.addEventListener('click', (event) => {
      event.preventDefault();
      const patientId = patientName.dataset.patientId;

      const filteredStories = stories.filter(story => story.user._id === patientId);

      let measurementTable = `<tr><td colspan="3"><table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Aika</th>
                                        <th>mmol/l</th>
                                        <th>Tuntemus</th>
                                        <th>G HH</th>
                                        <th>Liikunta</th>
                                        <th>Kommentti</th>
                                        <th>Toiminnot</th>
                                    </tr>
                                </thead>
                                <tbody>`;

      filteredStories.forEach(story => {
        measurementTable += `
          <tr>
            <td>${new Date(story.createdAt).toLocaleString()}</td>
            <td>${story.mmolPerL}</td>
            <td>${story.feeling}</td>
            <td>${story.GHH}</td>
            <td>${story.sport} ${story.sportDuration} min</td>
            <td>${story.body}</td>
            <td>
              <a href="/stories/edit/${story._id}" class="btn btn-primary btn-sm btn-edit" data-story-id="${story._id}">muokkaa</a>
              <button type="button" class="btn btn-danger btn-sm btnDel" data-story-id="${story._id}">Poista</button>
            </td>
          </tr>`;
      });

      measurementTable += `</tbody></table></td></tr>`;

      // Remove any existing measurement table
      const existingMeasurementTable = document.querySelector('.measurement-row');
      if (existingMeasurementTable) {
        existingMeasurementTable.remove();
      }

      // Insert the new measurement table after the clicked patient row
      const newRow = document.createElement('tr');
      newRow.classList.add('measurement-row');
      newRow.innerHTML = measurementTable;
      const parentRow = patientName.closest('tr');
      parentRow.parentNode.insertBefore(newRow, parentRow.nextSibling);
    });
  });
</script>
